SELECT DNP.ESI_ID, DNP.MTR_NO, DNP.JOB_CD, 
	   DNP.MAX_ACTUAL_END_TS,
	   PREM.ELEC_ACCT_ID, PREM.NAME, PREM.STREET_NUMBER, 
	   PREM.STREET_PREFIX, PREM.STREET_NAME,PREM.ROUTE,
	   PREM.STREET_SUFFIX, PREM.STREET_APARTMENT,PREM.CITY, 
	   PREM.ZIP_CD,PREM.SERVICE_CENTER, PREM.ACCT_RECEIVABLE_STATUS,
	   METER.MS_UNGR,
	   SUBSTRING (TROUBLE.JOB_CODE, 1, 6) AS TROUBLE_CALL,
	   TROUBLE.LAST_TBL_TIMESTAMP AS TROUBLE_CALL_TS,
	   CREW.JOB_CODE AS CREW_ONSITE_JOB,
	   CREW.CREW_ONSITE_TS AS LAST_CREW_ONSITE_TS

FROM 
	(SELECT 
	INSERT_TS,
	ESI_ID,
	JOB_CD,
	MTR_NO,
	MAX(ACTUAL_END_TS) AS MAX_ACTUAL_END_TS
	FROM "STG.T_STG_EAI_SVC_ORDERS_HIST"
	WHERE ACTUAL_END_TS 
	BETWEEN TO_TIMESTAMP(add_days(current_date,-9999)) AND to_timestamp(add_days(current_date,-1))
	and BPI_STATE != 'CANCELLATION'
	AND JOB_CD LIKE '%DNP%'
	GROUP BY INSERT_TS, ESI_ID, JOB_CD, MTR_NO) DNP

LEFT JOIN
	(
	SELECT ESI_ID, JOB_CODE, LAST_TBL_TIMESTAMP
	FROM
	(
	SELECT
	ESI_ID,JOB_CODE,
	TO_TIMESTAMP(TO_DATE("ONSITE_DT")||' ' || TO_TIME("ONSITE_TIME")) AS LAST_TBL_TIMESTAMP,
	ROW_NUMBER() OVER
	(PARTITION BY ESI_ID ORDER BY TO_TIMESTAMP(TO_DATE("ONSITE_DT")||' ' ||
	TO_TIME("ONSITE_TIME")) DESC) AS MYRANK
	FROM "YOURSCHEMA"."STG.T_MOBILE_DATA_CREW_ONSITE_HIST"
	)
	WHERE JOB_CODE LIKE '%TBL%'
	AND MYRANK = 1
	) TROUBLE
ON DNP.ESI_ID = TROUBLE.ESI_ID

LEFT JOIN
	(
	SELECT ESI_ID, JOB_CODE, CREW_ONSITE_TS
	FROM
	(
	SELECT
	ESI_ID,JOB_CODE,
	TO_TIMESTAMP(TO_DATE("ONSITE_DT")||' ' || TO_TIME("ONSITE_TIME")) AS
	CREW_ONSITE_TS,
	ROW_NUMBER() OVER
	(PARTITION BY ESI_ID ORDER BY TO_TIMESTAMP(TO_DATE("ONSITE_DT")||' ' ||
	TO_TIME("ONSITE_TIME")) DESC) AS MYRANK
	FROM "YOURSCHEMA"."STG.T_MOBILE_DATA_CREW_ONSITE_HIST"
	)
	WHERE JOB_CODE NOT LIKE '%TBL%'
	AND MYRANK = 1
	) CREW
ON DNP.ESI_ID = CREW.ESI_ID

LEFT JOIN
	(
	SELECT
	ESIID, ELEC_ACCT_ID, NAME, STREET_NUMBER, STREET_PREFIX, STREET_NAME, 
	STREET_SUFFIX, STREET_APARTMENT, CITY, ZIP_CD, SERVICE_CENTER,
	ACCT_RECEIVABLE_STATUS, ROUTE
	FROM "YOURSCHEMA"."STG.PREMISE_CHAR"
	) PREM
ON DNP.ESI_ID = PREM.ESIID

LEFT JOIN
	(
	SELECT
	ESIID, MS_UNGR
	FROM "YOURSCHEMA"."STG.METER_CHAR"
	) METER
ON DNP.ESI_ID = METER.ESIID

LEFT JOIN
	(SELECT 
	INSERT_TS,ESI_ID,
	JOB_CD,
	ACTUAL_END_TS
	FROM "STG.T_STG_EAI_SVC_ORDERS_HIST"
	WHERE ACTUAL_END_TS
	BETWEEN TO_TIMESTAMP(add_days(current_date,-9999))
	and TO_TIMESTAMP(add_days(current_date,-1))
	and JOB_CD LIKE '%MVO%' or JOB_CD LIKE '%MVI%' or JOB_CD LIKE '%RNP%'
	) FILTER
ON DNP.ESI_ID = FILTER.ESI_ID

LEFT JOIN
	(
	SELECT a.SDP_WID, b.UDC_ID as ESIID, MONTH_END, MONTHLY_USAGE
	from
	(
	select
	SDP_WID,
	ADD_MONTHS(ADD_DAYS(TO_DATE(DATE_WID),-EXTRACT (day from 
	TO_DATE(DATE_WID))),1) AS MONTH_END,
	SUM(INTERVAL_VALUE) AS MONTHLY_USAGE
	
	FROM "YOURSCHEMA"."EIP_RA.EIP_RA_USR.INTERVAL_F"
	WHERE
	ADD_MONTHS(ADD_DAYS(TO_DATE(DATE_WID),-EXTRACT (day from 
	TO_DATE(DATE_WID))),1)
	BETWEEN add_months(current_date,-53) and add_months(current_date,-52)
	
	GROUP BY SDP_WID, ADD_MONTHS(ADD_DAYS(TO_DATE(DATE_WID),-EXTRACT (day from TO_DATE(DATE_WID))),1)
	) a
	INNER JOIN
	"YOURSCHEMA"."EIP_RA.EIP_RA_USR.SDP_D" b
	on a.SDP_WID = b.WID
	WHERE MONTHLY_USAGE >= 200
	) MUSAGE
ON DNP.ESI_ID = MUSAGE.ESIID	
